define(["jquery","core/notification","core/templates","core/ajax","profilefield_conditional/dialogue","profilefield_conditional/otherfields"],function(a,b,c,d,e,f){var g=function(b,c,d,e){this.selectSelector=b,this.inputSelector=c,this.triggerSelector=d,this.fieldId=e,a(d).click(this.showConfig.bind(this))};return g.prototype.selectSelector=null,g.prototype.inputSelector=null,g.prototype.triggerSelector=null,g.prototype.fieldId=null,g.prototype.otherFields=null,g.prototype.options=null,g.prototype.popup=null,g.prototype.showConfig=function(){var d=this;this.options=[],a(this.selectSelector).val().replace(/\r\n/,"\n").split("\n").forEach(function(a,b){a&&d.options.push({index:b,option:a})}),this.getOtherFields(this.fieldId).done(function(){var a={options:d.options,fields:d.otherFields};c.render("profilefield_conditional/condition_configuration_page",a).done(function(a){new e("",a,d.initConditionConfig.bind(d))}).fail(b.exception)}).fail(b.exception)},g.prototype.retrieveConditionConfig=function(){var b=a(this.inputSelector).val();return""!==b?a.parseJSON(b):""},g.prototype.applyRestriction=function(b){var c=b.id,d=a(b).attr("data-field"),e="",f="";if(a(b).hasClass("profilefield_conditional_field_required")?(e=d.replace("profilefield_conditional_field_required_","profilefield_conditional_field_hidden_"),f=c.replace("required_","hidden_")):a(b).hasClass("profilefield_conditional_field_hidden")&&(e=d.replace("profilefield_conditional_field_hidden_","profilefield_conditional_field_required_"),f=c.replace("hidden_","required_")),""!==f&&f!=c){var g=e.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\0/g,"\\0");a(b).is(":checked")?(a(b).parent().parent().find('[data-field="'+g+'"]').attr("checked",!1),a(b).parent().parent().find('[data-field="'+g+'"]').prop("disabled",!0)):a(b).parent().parent().find('[data-field="'+g+'"]').prop("disabled",!1)}},g.prototype.initConditionConfig=function(b){this.popup=b;var c=this,d=a(b.getContent()),e=this.retrieveConditionConfig();""!==e&&e.forEach(function(a){var b=a.option.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\0/g,"\\0");a.requiredfields.forEach(function(a){d.find('[data-field="profilefield_conditional_field_required_'+b+"_"+a+'"]').attr("checked",!0),d.find('[data-field="profilefield_conditional_field_required_'+b+"_"+a+'"]').each(function(){c.applyRestriction(this)})}),a.hiddenfields.forEach(function(a){d.find('[data-field="profilefield_conditional_field_hidden_'+b+"_"+a+'"]').attr("checked",!0),d.find('[data-field="profilefield_conditional_field_hidden_'+b+"_"+a+'"]').each(function(){c.applyRestriction(this)})})}),d.on("click",'[data-action="close"]',function(){this.setConditionConfig(),b.close()}.bind(this)),d.on("click",'[data-action="cancel"]',function(){b.close()}),d.on("click",'[type="checkbox"]',function(a){this.applyRestriction(a.target)}.bind(this))},g.prototype.setConditionConfig=function(){var b=this,c=a(this.popup.getContent()),d=[];this.options.forEach(function(a){var e=[],f=[],g=a.option.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\0/g,"\\0");b.otherFields.forEach(function(a){c.find('[data-field="profilefield_conditional_field_required_'+g+"_"+a.shortname+'"]').is(":checked")&&e.push(a.shortname),c.find('[data-field="profilefield_conditional_field_hidden_'+g+"_"+a.shortname+'"]').is(":checked")&&f.push(a.shortname)}),d.push({option:a.option,requiredfields:e,hiddenfields:f})});var e=JSON.stringify(d);a(this.inputSelector).val(e)},g.prototype.getOtherFields=function(a){return f.getFields(a).then(function(a){return this.otherFields=a,a}.bind(this))},{init:function(a,b,c,d){return new g(a,b,c,d)}}});